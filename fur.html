<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }

        canvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://code.jquery.com/pep/0.4.3/pep.js"></script>
    <script src="/js/fur.js"></script>
    <script src="./js/dat.js"></script>
    <script src="./js/dat.js"></script>
</head>

<body>
    <canvas id="renderCanvas"></canvas>

    <script>
        const canvas = document.querySelector('#renderCanvas')
        const engine = new BABYLON.Engine(canvas, true, { stencil: true })
        const scene = createScene()

        engine.runRenderLoop(function () {

            scene.render();
        });

        // Watch for browser/canvas resize events
        window.addEventListener("resize", function () {
            engine.resize();
        });


        function createScene() {
            var scene = new BABYLON.Scene(engine);

            // Camera
            var camera = new BABYLON.ArcRotateCamera("Camera", Math.PI / 2, Math.PI / 6, 150, BABYLON.Vector3.Zero(), scene);
            camera.attachControl(canvas, true);
            camera.minZ = 0.1;

            // Light
            var light = new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(0, 1, 0), scene);
            light.intensity = 0.7;

            // Sphere
            window.sphere = BABYLON.Mesh.CreateSphere("sphere1", 48, 30, scene);

            // Fur Material
            var furMaterial = new BABYLON.FurMaterial("fur", scene);
            furMaterial.furLength = 4;
            furMaterial.furAngle = 0;
            furMaterial.furColor = new BABYLON.Color3(1, 0, 1);
            furMaterial.diffuseTexture = new BABYLON.Texture("/resources/texture/fur.jpg", scene);
            furMaterial.furTexture = BABYLON.FurMaterial.GenerateTexture("furTexture", scene);
            furMaterial.furSpacing = 6;
            furMaterial.furDensity = 3;

            furMaterial.furSpeed = 200;
            furMaterial.furGravity = new BABYLON.Vector3(0, -1, 0);

            sphere.material = furMaterial;

            // Furify the sphere to create the high level fur effect
            // The first argument is sphere itself. The second represents
            // the quality of the effect
            window.quality = 30;
            window.shells = BABYLON.FurMaterial.FurifyMesh(sphere, quality);
            initGUI(sphere.material)
            return scene;

        };

        function initGUI(obj) {
            const gui = new dat.GUI()

            const folder = gui.addFolder('title')
            for (let i in obj) {
                if (typeof (obj[i]) === 'number')
                    folder.add(obj, i).min(0).max(200)
            }
            var obj = {
                add: function () {
                    for (var i = 0; i < shells.length; i++) {

                        // shells[i].material.dispose();
                        shells[i].dispose();
                    }
                    BABYLON.FurMaterial.FurifyMesh(sphere, quality);
                }
            };

            gui.add(obj, 'add');
        }
    </script>
</body>

</html>